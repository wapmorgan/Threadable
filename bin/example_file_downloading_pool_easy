#!/usr/bin/env php
<?php

use wapmorgan\Threadable\BackgroundWork;
use wapmorgan\Threadable\DownloadWorker;
use wapmorgan\Threadable\Worker;
use wapmorgan\Threadable\WorkersPool;
require_once __DIR__.'/../vendor/autoload.php';

$file_sources = [/*'https://yandex.ru/images/today?size=1920x1080', */'http://hosting-obzo-ru.1gb.ru/hosting-obzor.ru.zip', 'http://soft.eurodir.ru/test-speed-100Mb.bin'];
$files = [];
foreach ($file_sources as $file_to_download) {
    $file_size = DownloadWorker::getRemoteFileSize($file_to_download);
    $output = tempnam(sys_get_temp_dir(), 'thrd_test');
    $files[] = [
        'source' => $file_to_download,
        'size' => $file_size,
        'target' => $output,
    ];
}

BackgroundWork::doInBackgroundParallel(new DownloadWorker(), $files, function (Worker $worker, $payloadI, $payloadData) {
    clearstatcache(true, $payloadData['target']);
    echo "\r" . '#' . ($payloadI + 1) . '. ' . basename($payloadData['source']) . ' downloading ' . round(filesize($payloadData['target']) * 100 / $payloadData['size'], 2) . '%';
}, function (Worker $worker, $payloadI, $payloadData, $payloadResult) {
    echo "\r" . '#' . ($payloadI + 1) . '. ' . basename($payloadData['source']) . ' successfully downloaded' . PHP_EOL;
    return true;
});
